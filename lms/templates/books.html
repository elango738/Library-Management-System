{% extends 'layout.html' %}
{% block content %}
  <div class="page-header">
    <h2>Books</h2>
    <div class="controls">
      <form method="get" action="{{ url_for('list_books') }}">
        <input type="search" name="q" placeholder="Search by title, author, or ISBN" value="{{ q }}">
        <button type="submit">Search</button>
      </form>
      {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <a class="btn" href="{{ url_for('add_book') }}">+ Add Book</a>
      {% endif %}
    </div>
  </div>

  <table class="table">
    <thead>
      <tr><th>Title</th><th>Author</th><th>ISBN</th><th>Available</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for book in books %}
      <tr>
        <td>{{ book.title }}</td>
        <td>{{ book.author }}</td>
        <td>{{ book.isbn }}</td>
        <td>{{ book.copies_available }} / {{ book.copies_total }}</td>
        <td>
          {# Issue button: available to any logged-in user when copies exist #}
          {% if current_user.is_authenticated and book.copies_available > 0 %}
            <a class="btn small" href="{{ url_for('issue_book') }}?book_id={{ book.id }}">Issue</a>
          {% elif book.copies_available > 0 %}
            <a class="btn small" href="{{ url_for('login', next=url_for('issue_book') + '?book_id=' + (book.id|string)) }}">Login to issue</a>
          {% else %}
            <span class="muted">Unavailable</span>
          {% endif %}

          {# Delete only for admins (server-enforced) #}
          {% if current_user.is_authenticated and current_user.role == 'admin' %}
            <form method="post" action="{{ url_for('delete_book', book_id=book.id) }}" onsubmit="return confirm('Delete book?');" style="display:inline;margin-left:8px">
              <button class="btn small danger">Delete</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5" class="muted">No books found.</td></tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock %}
